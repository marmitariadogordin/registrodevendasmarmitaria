<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marmitaria do Gordin - Sistema Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* === VARI√ÅVEIS CSS PREMIUM === */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }

        /* === BASE STYLES === */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 0 20px; }

        /* === HEADER PREMIUM === */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 0;
            box-shadow: var(--shadow-sm);
            position: sticky; top: 0; z-index: 100;
        }

        .header-content {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 1rem;
        }

        .logo {
            display: flex; align-items: center; gap: 0.75rem;
            font-size: 1.75rem; font-weight: 700;
            background: var(--primary-gradient); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; background-clip: text;
        }

        .header-actions { display: flex; align-items: center; gap: 1rem; }

        /* === BUTTONS PREMIUM === */
        .btn {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.75rem 1.5rem; border: none; border-radius: var(--radius-md);
            font-weight: 500; cursor: pointer; text-decoration: none;
            transition: var(--transition); font-size: 0.875rem;
            position: relative; overflow: hidden;
        }

        .btn::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before { left: 100%; }

        .btn-primary { background: var(--primary-gradient); color: white; }
        .btn-success { background: var(--success-gradient); color: white; }
        .btn-danger { background: var(--danger-gradient); color: white; }
        .btn-warning { background: var(--warning-gradient); color: white; }
        .btn-outline { background: transparent; color: var(--text-primary); border: 2px solid var(--border-color); }
        .btn-outline:hover { background: var(--bg-primary); }

        .btn-icon { 
            width: 2.5rem; height: 2.5rem; border-radius: 50%; justify-content: center; font-size: 1rem; 
            background: var(--bg-primary); color: var(--text-secondary); border: 1px solid var(--border-color);
        }

        .btn-icon:hover { background: var(--primary-gradient); color: white; transform: scale(1.05); }

        .btn-group {
            display: flex; gap: 0.5rem; background: var(--bg-primary);
            padding: 0.5rem; border-radius: var(--radius-lg); border: 1px solid var(--border-color);
        }

        /* === CARDS PREMIUM === */
        .cards-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem; margin: 2rem 0;
        }

        .card {
            background: var(--bg-secondary); border-radius: var(--radius-lg);
            padding: 1.5rem; box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color); transition: var(--transition);
            position: relative; overflow: hidden; cursor: pointer;
        }

        .card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: var(--primary-gradient);
        }

        .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .card-title { color: var(--text-secondary); font-size: 0.875rem; font-weight: 500; }
        .card-icon { font-size: 1.5rem; }
        .card-value { font-size: 2.25rem; font-weight: 700; margin: 0; line-height: 1.2; }

        .card-vendas .card-value { color: #10b981; }
        .card-saldo .card-value { color: #3b82f6; }

        /* === FILTERS PREMIUM === */
        .filters {
            background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius-lg);
            margin-bottom: 2rem; box-shadow: var(--shadow-md);
            display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: space-between;
        }

        .filter-group {
            display: flex; align-items: center; gap: 0.5rem;
            background: var(--bg-primary); padding: 0.5rem 1rem; border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .filter-btn {
            padding: 0.5rem 1rem; border: none; background: transparent;
            border-radius: var(--radius-sm); cursor: pointer; transition: var(--transition);
            font-weight: 500;
        }

        .filter-btn.active { background: var(--primary-gradient); color: white; }

        /* === DASHBOARD GRID === */
        .dashboard-grid {
            display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 2rem;
        }

        .widget {
            background: var(--bg-secondary); border-radius: var(--radius-lg);
            padding: 1.5rem; box-shadow: var(--shadow-md); border: 1px solid var(--border-color);
        }

        .widget-title {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; font-size: 1.125rem; font-weight: 600;
        }

        .chart-container { position: relative; height: 350px; width: 100%; }

        /* === TABLES PREMIUM === */
        .table-container { max-height: 400px; overflow-y: auto; border-radius: var(--radius-md); }

        table { width: 100%; border-collapse: collapse; }
        th {
            background: var(--bg-primary); padding: 1rem; text-align: left; font-weight: 600;
            color: var(--text-secondary); border-bottom: 2px solid var(--border-color);
            position: sticky; top: 0; z-index: 10;
        }
        td { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        tr:hover { background: var(--bg-primary); }

        .status-badge {
            padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;
        }
        .status-aberto { background: #dbeafe; color: #1e40af; }
        .status-fechado { background: #fef3c7; color: #92400e; }

        /* === MODALS PREMIUM === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center;
            z-index: 1000; padding: 1rem; backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--bg-secondary); border-radius: var(--radius-lg);
            max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto;
            box-shadow: var(--shadow-lg); animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .modal-header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 1.5rem; border-bottom: 1px solid var(--border-color); 
        }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select {
            width: 100%; padding: 0.75rem; border: 2px solid var(--border-color);
            border-radius: var(--radius-md); background: var(--bg-primary); color: var(--text-primary);
            transition: var(--transition);
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .item-row {
            display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 0.5rem; margin: 0.5rem 0;
            align-items: center;
        }

        /* === TOAST NOTIFICATIONS === */
        .toast-container {
            position: fixed; top: 1.5rem; right: 1.5rem; z-index: 2000;
            display: flex; flex-direction: column; gap: 1rem;
        }

        .toast {
            padding: 1rem 1.5rem; border-radius: var(--radius-md); color: white;
            font-weight: 500; box-shadow: var(--shadow-lg);
            transform: translateX(100%); animation: toastSlideIn 0.3s ease-out forwards;
            min-width: 300px;
        }

        @keyframes toastSlideIn { to { transform: translateX(0); } }

        .toast.success { background: var(--success-gradient); }
        .toast.error { background: var(--danger-gradient); }

        /* === STOCK ALERTS === */
        .stock-low { color: #ef4444; font-weight: 600; }
        .stock-critical { color: #dc2626; font-weight: 700; }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; align-items: stretch; }
            .header-content { flex-direction: column; gap: 1rem; }
            .item-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body data-theme="light">
    <div class="toast-container" id="toast-container"></div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-utensils"></i> Marmitaria do Gordin
                </div>
                <div class="header-actions">
                    <div class="btn-group">
                        <button class="btn-icon" id="btn-export-pdf-vendas" title="PDF Vendas"><i class="fas fa-file-pdf"></i></button>
                        <button class="btn-icon" id="btn-export-csv-vendas" title="CSV Vendas"><i class="fas fa-file-csv"></i></button>
                        <button class="btn-icon" id="btn-export-pdf-caixa" title="PDF Caixa"><i class="fas fa-file-pdf"></i></button>
                    </div>
                    <button class="btn-icon" id="btn-theme-toggle" title="Tema"><i class="fas fa-moon"></i></button>
                    <div class="btn-group">
                        <button class="btn btn-primary" id="btn-abrir-modal-produto"><i class="fas fa-box"></i> Produto</button>
                        <button class="btn btn-success" id="btn-abrir-modal-venda"><i class="fas fa-shopping-cart"></i> Pedido</button>
                        <button class="btn btn-primary" id="btn-abrir-caixa"><i class="fas fa-cash-register"></i> Abrir Caixa</button>
                        <button class="btn btn-danger" id="btn-encerrar-caixa"><i class="fas fa-times"></i> Encerrar Caixa</button>
                        <button class="btn btn-primary" id="btn-hist-caixa"><i class="fas fa-history"></i> Hist√≥rico Caixa</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- DASHBOARD CARDS -->
        <div class="cards-grid">
            <div class="card card-vendas" id="card-vendas">
                <div class="card-header">
                    <span class="card-title">Vendas</span>
                    <i class="fas fa-chart-line card-icon"></i>
                </div>
                <p class="card-value" id="total-vendas">R$ 0,00</p>
            </div>
            <div class="card card-saldo" id="card-saldo">
                <div class="card-header">
                    <span class="card-title">Saldo</span>
                    <i class="fas fa-scale-balanced card-icon"></i>
                </div>
                <p class="card-value" id="saldo-total">R$ 0,00</p>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="filters">
            <div class="filter-group">
                <button class="filter-btn" data-periodo="Diario">Hoje</button>
                <button class="filter-btn" data-periodo="Semanal">Semana</button>
                <button class="filter-btn active" data-periodo="Mensal">M√™s</button>
                <button class="filter-btn" data-periodo="Anual">Ano</button>
            </div>
            <div class="filter-group">
                <input type="date" id="data-inicio">
                <input type="date" id="data-fim">
                <button class="btn btn-primary" id="btn-aplicar-filtro-data">Filtrar</button>
            </div>
        </div>

        <!-- LOADING -->
        <div id="loading" style="display: flex; justify-content: center; align-items: center; min-height: 200px;">
            <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--text-secondary);"></i>
        </div>

        <!-- DASHBOARD -->
        <div id="dashboard-content" style="display: none;">
            <div class="dashboard-grid">
                <div class="widget">
                    <div class="widget-title">
                        <span id="titulo-grafico">Evolu√ß√£o de Vendas</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="grafico-linhas"></canvas>
                    </div>
                </div>

                <div class="widget">
                    <div class="widget-title">
                        <span id="titulo-categorias">Top 10 Produtos Vendidos</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="grafico-categorias"></canvas>
                    </div>
                </div>

                <div class="widget" style="grid-column: 1 / -1;">
                    <div class="widget-title">
                        <span>Estoque de Produtos</span>
                        <button class="btn-icon btn-success" id="btn-adicionar-produto"><i class="fas fa-plus"></i></button>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Pre√ßo</th>
                                    <th>Estoque</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="corpo-tabela-estoque"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DETALHES -->
    <div class="modal-overlay" id="modal-detalhes">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-detalhes-titulo">Detalhes</h3>
                <button class="btn-icon btn-danger" id="btn-fechar-detalhes">&times;</button>
            </div>
            <div id="modal-detalhes-conteudo" class="table-container"></div>
        </div>
    </div>

    <!-- Modal Produto -->
    <div class="modal-overlay" id="modal-registro-produto">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-produto-titulo">Cadastrar Produto</h3>
                <button class="btn-icon btn-danger" id="btn-fechar-produto">&times;</button>
            </div>
            <form id="form-produto">
                <input type="hidden" id="prod-id">
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" id="prod-nome" required>
                </div>
                <div class="form-group">
                    <label>Pre√ßo (R$)</label>
                    <input type="text" id="prod-preco" placeholder="0,00" required>
                </div>
                <div class="form-group">
                    <label>Estoque</label>
                    <input type="number" id="prod-estoque" min="0" required>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" id="btn-cancelar-produto">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Venda -->
    <div class="modal-overlay" id="modal-registro-venda">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Registrar Pedido</h3>
                <button class="btn-icon btn-danger" id="btn-fechar-venda">&times;</button>
            </div>
            <form id="form-venda">
                <div class="form-group">
                    <label>Pagamento</label>
                    <select id="venda-pagamento" required>
                        <option value="Dinheiro">Dinheiro</option>
                        <option value="Cartao">Cart√£o</option>
                        <option value="Pix">Pix</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
                <div id="itens-list"></div>
                <button type="button" class="btn btn-success" id="btn-add-item">+ Item</button>
                <div style="margin: 1rem 0; font-size: 1.25rem; font-weight: 600;">
                    Total: <span id="venda-total">R$ 0,00</span>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" id="btn-cancelar-venda">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Abrir Caixa -->
    <div class="modal-overlay" id="modal-abrir-caixa">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Abrir Caixa</h3>
                <button class="btn-icon btn-danger" id="btn-fechar-abrir-caixa">&times;</button>
            </div>
            <form id="form-abrir-caixa">
                <div class="form-group">
                    <label>Valor Inicial (R$)</label>
                    <input type="text" id="caixa-valor-inicial" placeholder="0,00" required>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" id="btn-cancelar-abrir-caixa">Cancelar</button>
                    <button type="submit" class="btn btn-success">Abrir</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Hist√≥rico Caixa -->
    <div class="modal-overlay" id="modal-caixa-hist">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Hist√≥rico de Caixas</h3>
                <button class="btn-icon btn-danger" id="btn-fechar-caixa-hist">&times;</button>
            </div>
            <div style="padding: 0 1.5rem 1.5rem;">
                <div class="filters" style="margin: -1.5rem -1.5rem 1.5rem -1.5rem;">
                    <div class="filter-group">
                        <button class="filter-btn" data-periodo="Diario">Hoje</button>
                        <button class="filter-btn" data-periodo="Semanal">Semana</button>
                        <button class="filter-btn active" data-periodo="Mensal">M√™s</button>
                        <button class="filter-btn" data-periodo="Anual">Ano</button>
                    </div>
                    <div class="filter-group">
                        <input type="date" id="data-inicio-caixa">
                        <input type="date" id="data-fim-caixa">
                        <button class="btn btn-primary" id="btn-aplicar-filtro-data-caixa">Filtrar</button>
                    </div>
                </div>
                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header"><span>Total Inicial</span><i class="fas fa-money-bill-wave"></i></div>
                        <p class="card-value" id="total-inicial-caixa">R$ 0,00</p>
                    </div>
                    <div class="card">
                        <div class="card-header"><span>Total Final</span><i class="fas fa-money-check"></i></div>
                        <p class="card-value" id="total-final-caixa">R$ 0,00</p>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Data Abertura</th>
                                <th>Data Encerramento</th>
                                <th>Valor Inicial</th>
                                <th>Valor Final</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="corpo-tabela-caixa"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            'use strict';

            // === SUPABASE CONFIG (INTACTO) ===
            const SUPABASE_URL = 'https://jrbhvzczkzuyigwiomaa.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpyYmh2emN6a3p1eWlnd2lvbWFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzQzNDUsImV4cCI6MjA3NjU1MDM0NX0.bs4GzZa2iPCkuvOUy4OpKmuT2n6NLPr857Qe1hytJSc';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // === VARI√ÅVEIS GLOBAIS (ORIGINAIS) ===
            let produtos = [];
            let pedidosGeral = [];
            let itensGeral = [];
            let pedidosFiltrados = [];
            let itensFiltrados = [];
            let caixasGeral = [];
            let caixasFiltrados = [];
            let caixaAtual = null;
            let graficoLinhas = null;
            let graficoCategorias = null;

            // === FUN√á√ïES AUXILIARES (ORIGINAIS) ===
            const formatarMoeda = (valor) => (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const formatarData = (data) => data instanceof Date && !isNaN(data) ? data.toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : 'Data inv√°lida';

            function formatarInputMoeda(inputEl) {
                let valor = inputEl.value.replace(/\D/g, '');
                valor = (parseInt(valor, 10) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                if (valor === 'NaN') valor = '';
                inputEl.value = valor;
            }

            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                const icon = type === 'success' ? 'fa-check-circle' : 'fa-times-circle';
                toast.innerHTML = `<i class="fas ${icon}"></i> ${message}`;
                document.getElementById('toast-container').appendChild(toast);
                setTimeout(() => toast.remove(), 4000);
            }

            function aplicarTema(tema) {
                document.documentElement.dataset.theme = tema;
                document.getElementById('btn-theme-toggle').innerHTML = `<i class="fas fa-${tema === 'dark' ? 'sun' : 'moon'}"></i>`;
                localStorage.setItem('temaDashboard', tema);
            }

            // === CARREGAR DADOS (L√ìGICA ORIGINAL) ===
            async function carregarDadosIniciais() {
                const loadingDiv = document.getElementById('loading');
                const dashboardContentDiv = document.getElementById('dashboard-content');
                
                loadingDiv.style.display = 'flex';
                dashboardContentDiv.style.display = 'none';

                try {
                    const { data: produtosData } = await supabase.from('produtos').select('*');
                    produtos = produtosData || [];
                    
                    const { data: pedidosData } = await supabase.from('pedidos').select('*');
                    pedidosGeral = pedidosData.map(item => ({ ...item, data: new Date(item.data) })).filter(p => p.data instanceof Date && !isNaN(p.data)) || [];
                    
                    const { data: itensData } = await supabase.from('itens_pedido').select('*, produto:produto_id (nome)');
                    itensGeral = itensData.map(item => ({ ...item, produto_nome: item.produto ? item.produto.nome : 'Produto Desconhecido' })) || [];
                    
                    const { data: caixaData } = await supabase.from('caixa').select('*').order('data_abertura', { ascending: false });
                    caixasGeral = caixaData.map(c => ({ ...c, data_abertura: new Date(c.data_abertura), data_encerramento: c.data_encerramento ? new Date(c.data_encerramento) : null })) || [];
                    caixaAtual = caixasGeral.find(c => !c.data_encerramento) || null;

                    aplicarFiltros();
                    renderizarEstoque();
                    loadingDiv.style.display = 'none';
                    dashboardContentDiv.style.display = 'block';
                    showToast('Dados carregados!', 'success');
                } catch (error) {
                    console.error('Erro ao buscar dados:', error);
                    showToast(`Falha ao carregar: ${error.message}`, 'error');
                    loadingDiv.style.display = 'none';
                }
            }

            // === OPERA√á√ïES CRUD (L√ìGICA ORIGINAL INTACTA) ===
            async function submeterProduto(dados, id = null) {
                try {
                    const { error } = id
                        ? await supabase.from('produtos').update(dados).eq('id', id)
                        : await supabase.from('produtos').insert([dados]);
                    if (error) throw error;
                    showToast(`Produto ${id ? 'atualizado' : 'cadastrado'}!`);
                    document.getElementById('modal-registro-produto').style.display = 'none';
                    carregarDadosIniciais();
                } catch (error) {
                    showToast(`Erro: ${error.message}`, 'error');
                }
            }

            async function submeterPedido(formaPagamento, itens) {
                if (itens.length === 0) {
                    showToast('Adicione pelo menos um item!', 'error');
                    return;
                }
                const valorTotal = itens.reduce((acc, item) => acc + (item.preco * item.quantidade), 0);
                const estoqueInsuficiente = itens.some(item => {
                    const prod = produtos.find(p => p.id === item.produto_id);
                    return prod.estoque < item.quantidade;
                });
                if (estoqueInsuficiente) {
                    showToast('Estoque insuficiente para algum item!', 'error');
                    return;
                }
                try {
                    const { data: pedidoData, error: pedidoError } = await supabase.from('pedidos').insert([{
                        data: new Date().toISOString().split('T')[0], 
                        forma_pagamento: formaPagamento, 
                        valor_total: valorTotal 
                    }]).select();
                    if (pedidoError) throw pedidoError;
                    
                    const pedidoId = pedidoData[0].id;
                    const itensToInsert = itens.map(item => ({ 
                        pedido_id: pedidoId, 
                        produto_id: item.produto_id, 
                        quantidade: item.quantidade, 
                        preco_unitario: item.preco 
                    }));
                    
                    const { error: itensError } = await supabase.from('itens_pedido').insert(itensToInsert);
                    if (itensError) throw itensError;
                    
                    for (const item of itens) {
                        const prod = produtos.find(p => p.id === item.produto_id);
                        await supabase.from('produtos').update({ 
                            estoque: prod.estoque - item.quantidade 
                        }).eq('id', item.produto_id);
                    }
                    
                    showToast('Pedido registrado!');
                    document.getElementById('modal-registro-venda').style.display = 'none';
                    carregarDadosIniciais();
                } catch (error) {
                    showToast(`Erro: ${error.message}`, 'error');
                }
            }

            async function abrirCaixa(valorInicial) {
                if (caixaAtual && !caixaAtual.data_encerramento) {
                    showToast('Caixa j√° aberto!', 'error');
                    return;
                }
                try {
                    const { data, error } = await supabase.from('caixa').insert([{
                        data_abertura: new Date().toISOString(), 
                        valor_inicial: valorInicial, 
                        valor_final: valorInicial 
                    }]).select();
                    if (error) throw error;
                    caixaAtual = data[0];
                    showToast('Caixa aberto!');
                    document.getElementById('modal-abrir-caixa').style.display = 'none';
                    carregarDadosIniciais();
                } catch (error) {
                    showToast(`Erro: ${error.message}`, 'error');
                }
            }

            async function encerrarCaixa() {
                if (!caixaAtual || caixaAtual.data_encerramento) {
                    showToast('Nenhum caixa aberto!', 'error');
                    return;
                }
                const totalVendas = calcTotalVendasForCaixa(caixaAtual);
                try {
                    const { error } = await supabase.from('caixa').update({ 
                        data_encerramento: new Date().toISOString(), 
                        valor_final: caixaAtual.valor_inicial + totalVendas 
                    }).eq('id', caixaAtual.id);
                    if (error) throw error;
                    showToast('Caixa encerrado!');
                    carregarDadosIniciais();
                } catch (error) {
                    showToast(`Erro: ${error.message}`, 'error');
                }
            }

            async function excluirPedido(id) {
                try {
                    const itens = itensGeral.filter(i => i.pedido_id === id);
                    for (const item of itens) {
                        const prod = produtos.find(p => p.id === item.produto_id);
                        await supabase.from('produtos').update({ 
                            estoque: prod.estoque + item.quantidade 
                        }).eq('id', item.produto_id);
                    }
                    await supabase.from('itens_pedido').delete().eq('pedido_id', id);
                    const { error } = await supabase.from('pedidos').delete().eq('id', id);
                    if (error) throw error;
                    showToast('Pedido exclu√≠do!');
                    carregarDadosIniciais();
                } catch (error) {
                    showToast(`Erro: ${error.message}`, 'error');
                }
            }

            async function excluirProduto(id) {
                if (itensGeral.some(i => i.produto_id === id)) {
                    showToast('Produto com vendas registradas n√£o pode ser exclu√≠do!', 'error');
                    return;
                }
                try {
                    const { error } = await supabase.from('produtos').delete().eq('id', id);
                    if (error) throw error;
                    showToast('Produto exclu√≠do!');
                    carregarDadosIniciais();
                } catch (error) {
                    showToast(`Erro: ${error.message}`, 'error');
                }
            }

            // === RENDERIZA√á√ÉO (L√ìGICA ORIGINAL) ===
            function aplicarFiltros(filtroId = 'filter-group', isCaixa = false) {
                const periodoFiltroBtn = document.querySelector('.filter-btn.active');
                const dataInicioInput = document.getElementById('data-inicio');
                const dataFimInput = document.getElementById('data-fim');
                const hoje = new Date();

                if (!isCaixa) {
                    pedidosFiltrados = pedidosGeral.filter(p => {
                        if (dataInicioInput?.value && dataFimInput?.value) {
                            const dataInicio = new Date(`${dataInicioInput.value}T00:00:00`);
                            const dataFim = new Date(`${dataFimInput.value}T23:59:59`);
                            return p.data >= dataInicio && p.data <= dataFim;
                        } else if (periodoFiltroBtn) {
                            switch (periodoFiltroBtn.dataset.periodo) {
                                case 'Diario': return dateFns.isSameDay(p.data, hoje);
                                case 'Semanal': return dateFns.isThisWeek(p.data, { weekStartsOn: 1 });
                                case 'Mensal': return dateFns.isSameMonth(p.data, hoje);
                                case 'Anual': return dateFns.isSameYear(p.data, hoje);
                                default: return true;
                            }
                        }
                        return true;
                    });
                    itensFiltrados = itensGeral.filter(i => pedidosFiltrados.some(p => p.id === i.pedido_id));
                    atualizarDashboard(pedidosFiltrados, itensFiltrados);
                } else {
                    caixasFiltrados = caixasGeral.filter(c => {
                        if (dataInicioInput?.value && dataFimInput?.value) {
                            const dataInicio = new Date(`${dataInicioInput.value}T00:00:00`);
                            const dataFim = new Date(`${dataFimInput.value}T23:59:59`);
                            return c.data_abertura >= dataInicio && c.data_abertura <= dataFim;
                        } else if (periodoFiltroBtn) {
                            switch (periodoFiltroBtn.dataset.periodo) {
                                case 'Diario': return dateFns.isSameDay(c.data_abertura, hoje);
                                case 'Semanal': return dateFns.isThisWeek(c.data_abertura, { weekStartsOn: 1 });
                                case 'Mensal': return dateFns.isSameMonth(c.data_abertura, hoje);
                                case 'Anual': return dateFns.isSameYear(c.data_abertura, hoje);
                                default: return true;
                            }
                        }
                        return true;
                    });
                    renderizarCaixaHist(caixasFiltrados);
                }
            }

            function atualizarDashboard(pedidos, itens) {
                document.getElementById('titulo-grafico').textContent = `Evolu√ß√£o de Vendas`;
                atualizarCards(pedidos);
                criarGraficoLinhas(pedidos);
                criarGraficoCategorias(itens);
            }

            function atualizarCards(pedidos) {
                const totalVendas = pedidos.reduce((acc, p) => acc + (p.valor_total || 0), 0);
                const totalInicialCaixas = caixasGeral.reduce((acc, c) => acc + (c.valor_inicial || 0), 0);
                document.getElementById('total-vendas').textContent = formatarMoeda(totalVendas);
                document.getElementById('saldo-total').textContent = formatarMoeda(totalVendas + totalInicialCaixas);
            }

            function renderizarEstoque() {
                const tbody = document.getElementById('corpo-tabela-estoque');
                tbody.innerHTML = produtos.sort((a, b) => a.nome.localeCompare(b.nome)).map(prod => `
                    <tr>
                        <td>${prod.nome}</td>
                        <td>${formatarMoeda(prod.preco)}</td>
                        <td class="${prod.estoque < 5 ? 'stock-low' : ''}">${prod.estoque}</td>
                        <td>
                            <button class="btn-icon btn-primary btn-edit-prod" data-id="${prod.id}" title="Editar">
                                <i class="fas fa-pencil"></i>
                            </button>
                            <button class="btn-icon btn-danger btn-delete-prod" data-id="${prod.id}" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="4" style="text-align:center;padding:2rem">Nenhum produto</td></tr>';
            }

            function criarGraficoLinhas(pedidos) {
                if (graficoLinhas) graficoLinhas.destroy();
                const ctx = document.getElementById('grafico-linhas').getContext('2d');
                
                if (pedidos.length === 0) return;

                const dadosAgrupados = pedidos.reduce((acc, p) => {
                    const dia = p.data.toLocaleDateString();
                    acc[dia] = (acc[dia] || 0) + p.valor_total;
                    return acc;
                }, {});
                
                const labels = Object.keys(dadosAgrupados).sort();
                graficoLinhas = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            label: 'Vendas',
                            data: labels.map(key => dadosAgrupados[key]),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            function criarGraficoCategorias(itens) {
                if (graficoCategorias) graficoCategorias.destroy();
                const ctx = document.getElementById('grafico-categorias').getContext('2d');
                
                if (itens.length === 0) return;

                const dadosAgrupados = itens.reduce((acc, i) => {
                    const produto = i.produto_nome || 'N√£o especificado';
                    acc[produto] = (acc[produto] || 0) + i.quantidade;
                    return acc;
                }, {});
                
                const top10 = Object.entries(dadosAgrupados).sort(([, a], [, b]) => b - a).slice(0, 10);
                graficoCategorias = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: top10.map(([produto]) => produto),
                        datasets: [{
                            data: top10.map(([, qtd]) => qtd),
                            backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444', '#06b6d4', '#8b5cf6', '#10b981', '#3b82f6', '#f59e0b']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            function calcTotalVendasForCaixa(caixa) {
                const vendasDoPeriodo = pedidosGeral.filter(p => 
                    dateFns.isAfter(p.data, caixa.data_abertura) && 
                    (!caixa.data_encerramento || dateFns.isBefore(p.data, caixa.data_encerramento))
                );
                return vendasDoPeriodo.reduce((acc, p) => acc + p.valor_total, 0);
            }

            function renderizarCaixaHist(caixas) {
                const tbody = document.getElementById('corpo-tabela-caixa');
                tbody.innerHTML = caixas.map(c => {
                    const valorFinal = c.valor_final || (c.valor_inicial + calcTotalVendasForCaixa(c));
                    return `
                        <tr>
                            <td>${formatarData(c.data_abertura)}</td>
                            <td>${c.data_encerramento ? formatarData(c.data_encerramento) : 'Aberto'}</td>
                            <td>${formatarMoeda(c.valor_inicial)}</td>
                            <td>${formatarMoeda(valorFinal)}</td>
                            <td>
                                <button class="btn-icon btn-primary btn-export-caixa" data-id="${c.id}" title="PDF">
                                    <i class="fas fa-file-pdf"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="5" style="text-align:center;padding:2rem">Nenhum caixa</td></tr>';

                const totalInicial = caixas.reduce((acc, c) => acc + c.valor_inicial, 0);
                const totalFinal = caixas.reduce((acc, c) => acc + (c.valor_final || (c.valor_inicial + calcTotalVendasForCaixa(c))), 0);
                
                document.getElementById('total-inicial-caixa').textContent = formatarMoeda(totalInicial);
                document.getElementById('total-final-caixa').textContent = formatarMoeda(totalFinal);
            }

            // === EXPORTA√á√ïES (L√ìGICA ORIGINAL) ===
            function exportarParaPDF() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text('Relat√≥rio de Pedidos', 14, 15);
                const tableData = pedidosFiltrados.map(p => [
                    formatarData(p.data), 
                    p.forma_pagamento, 
                    formatarMoeda(p.valor_total)
                ]);
                doc.autoTable({ 
                    head: [['Data', 'Pagamento', 'Valor']], 
                    body: tableData, 
                    startY: 25 
                });
                doc.save(`relatorio-pedidos-${new Date().toISOString().split('T')[0]}.pdf`);
                showToast('PDF exportado!', 'success');
            }

            function exportarParaCSV() {
                const headers = ['Data', 'Pagamento', 'Valor'];
                let csvContent = "data:text/csv;charset=utf-8," + headers.join(",") + "\n";
                pedidosFiltrados.forEach(p => {
                    const valorNumerico = (p.valor_total || 0).toFixed(2).replace('.', ',');
                    const row = [formatarData(p.data), `"${p.forma_pagamento}"`, `"${valorNumerico}"`];
                    csvContent += row.join(",") + "\n";
                });
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", `relatorio-pedidos-${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('CSV exportado!', 'success');
            }

            function exportarConferenciaCaixaPDF(caixa = caixaAtual) {
                if (!caixa) {
                    showToast('Caixa n√£o selecionado.', 'error');
                    return;
                }
                const totalVendas = calcTotalVendasForCaixa(caixa);
                const totalPorPagamento = pedidosGeral.filter(p => 
                    dateFns.isAfter(p.data, caixa.data_abertura) && 
                    (!caixa.data_encerramento || dateFns.isBefore(p.data, caixa.data_encerramento))
                ).reduce((acc, p) => {
                    acc[p.forma_pagamento] = (acc[p.forma_pagamento] || 0) + p.valor_total;
                    return acc;
                }, {});
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text('Confer√™ncia de Caixa', 14, 15);
                doc.text(`Data Abertura: ${formatarData(caixa.data_abertura)}`, 14, 25);
                doc.text(`Data Encerramento: ${caixa.data_encerramento ? formatarData(caixa.data_encerramento) : 'Aberto'}`, 14, 35);
                doc.text(`Valor Inicial: ${formatarMoeda(caixa.valor_inicial)}`, 14, 45);
                doc.text(`Total Vendas: ${formatarMoeda(totalVendas)}`, 14, 55);
                let y = 65;
                for (const [pag, valor] of Object.entries(totalPorPagamento)) {
                    doc.text(`${pag}: ${formatarMoeda(valor)}`, 14, y);
                    y += 10;
                }
                doc.text(`Valor Final: ${formatarMoeda(caixa.valor_final || (caixa.valor_inicial + totalVendas))}`, 14, y);
                doc.save(`conferencia-caixa-${caixa.id}-${new Date().toISOString().split('T')[0]}.pdf`);
                showToast('PDF Caixa exportado!', 'success');
            }

            // === MODAIS (L√ìGICA ORIGINAL) ===
            function exibirDetalhesModal(tipo) {
                const modal = document.getElementById('modal-detalhes');
                const pedidosParaExibir = tipo === 'Saldo' ? pedidosFiltrados : pedidosFiltrados;
                pedidosParaExibir.sort((a, b) => b.data - a.data);
                
                let titulo = tipo === 'Saldo' ? 'Detalhes do Saldo' : 'Detalhes de Pedidos';
                document.getElementById('modal-detalhes-titulo').textContent = `${titulo}`;

                let html = '<div style="padding:2rem;text-align:center"><p>Nenhum pedido encontrado.</p></div>';
                if (pedidosParaExibir.length > 0) {
                    const tableRows = pedidosParaExibir.map(p => {
                        const itensDoPedido = itensGeral.filter(i => i.pedido_id === p.id).map(i => `${i.produto_nome} x ${i.quantidade}`).join(', ');
                        return `
                            <tr>
                                <td>${formatarData(p.data)}</td>
                                <td>${itensDoPedido}</td>
                                <td>${p.forma_pagamento}</td>
                                <td>${formatarMoeda(p.valor_total)}</td>
                                <td>
                                    <button class="btn-icon btn-danger btn-delete-venda" data-id="${p.id}" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('');
                    html = `
                        <table>
                            <thead><tr><th>Data</th><th>Itens</th><th>Pagamento</th><th>Valor</th><th>A√ß√µes</th></tr></thead>
                            <tbody>${tableRows}</tbody>
                        </table>
                    `;
                }
                document.getElementById('modal-detalhes-conteudo').innerHTML = html;
                modal.style.display = 'flex';
            }

            function abrirModalProduto(id = null) {
                const modal = document.getElementById('modal-registro-produto');
                const form = document.getElementById('form-produto');
                form.reset();
                document.getElementById('prod-id').value = id || '';
                const produto = id ? produtos.find(p => p.id === id) : null;
                if (produto) {
                    document.getElementById('modal-produto-titulo').textContent = 'Editar Produto';
                    document.getElementById('prod-nome').value = produto.nome;
                    document.getElementById('prod-preco').value = (produto.preco || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                    document.getElementById('prod-estoque').value = produto.estoque;
                } else {
                    document.getElementById('modal-produto-titulo').textContent = 'Cadastrar Novo Produto';
                }
                modal.style.display = 'flex';
            }

            function abrirModalVenda() {
                if (!caixaAtual || caixaAtual.data_encerramento) {
                    showToast('Abra o caixa primeiro!', 'error');
                    return;
                }
                const modal = document.getElementById('modal-registro-venda');
                const itensList = document.getElementById('itens-list');
                itensList.innerHTML = '';
                document.getElementById('venda-total').textContent = formatarMoeda(0);
                document.getElementById('form-venda').reset();
                addItemRow();
                modal.style.display = 'flex';
            }

            function addItemRow() {
                const itensList = document.getElementById('itens-list');
                const row = document.createElement('div');
                row.className = 'item-row';
                row.innerHTML = `
                    <select class="venda-item-produto"></select>
                    <input type="number" class="venda-item-qtd" min="1" value="1">
                    <span class="item-subtotal">R$ 0,00</span>
                    <button type="button" class="btn-icon btn-danger btn-remove-item">&times;</button>
                `;
                itensList.appendChild(row);

                const selectProduto = row.querySelector('.venda-item-produto');
                produtos.forEach(prod => {
                    const option = document.createElement('option');
                    option.value = prod.id;
                    option.textContent = `${prod.nome} - R$ ${prod.preco.toFixed(2)} (Est: ${prod.estoque})`;
                    selectProduto.appendChild(option);
                });

                const updateSubtotal = () => {
                    const prodId = parseInt(selectProduto.value);
                    const qtd = parseInt(row.querySelector('.venda-item-qtd').value) || 0;
                    const prod = produtos.find(p => p.id === prodId);
                    const subtotal = prod ? prod.preco * qtd : 0;
                    row.querySelector('.item-subtotal').textContent = formatarMoeda(subtotal);
                    updateVendaTotal();
                };

                selectProduto.addEventListener('change', updateSubtotal);
                row.querySelector('.venda-item-qtd').addEventListener('input', updateSubtotal);
                row.querySelector('.btn-remove-item').addEventListener('click', () => {
                    row.remove();
                    updateVendaTotal();
                });
                updateSubtotal();
            }

            function updateVendaTotal() {
                let total = 0;
                document.querySelectorAll('.item-row').forEach(row => {
                    const subtotalText = row.querySelector('.item-subtotal').textContent;
                    const subtotal = parseFloat(subtotalText.replace('R$', '').replace(/\./g, '').replace(',', '.')) || 0;
                    total += subtotal;
                });
                document.getElementById('venda-total').textContent = formatarMoeda(total);
            }

            // === EVENT LISTENERS (L√ìGICA ORIGINAL) ===
            // Theme Toggle
            document.getElementById('btn-theme-toggle').addEventListener('click', () => {
                const temaAtual = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
                aplicarTema(temaAtual);
            });

            // Filtros
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    aplicarFiltros();
                });
            });

            document.getElementById('btn-aplicar-filtro-data').addEventListener('click', () => {
                aplicarFiltros();
            });

            // Forms
            document.getElementById('form-produto').addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById('prod-id').value;
                const precoInput = document.getElementById('prod-preco').value.replace(/\./g, '').replace(',', '.');
                if (isNaN(parseFloat(precoInput))) {
                    showToast('Valor inv√°lido.', 'error');
                    return;
                }
                const dados = {
                    nome: document.getElementById('prod-nome').value,
                    preco: parseFloat(precoInput),
                    estoque: parseInt(document.getElementById('prod-estoque').value)
                };
                submeterProduto(dados, id ? parseInt(id) : null);
            });

            document.getElementById('form-venda').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formaPagamento = document.getElementById('venda-pagamento').value;
                const rows = document.querySelectorAll('.item-row');
                const itens = [];
                rows.forEach(row => {
                    const produtoId = parseInt(row.querySelector('.venda-item-produto').value);
                    const quantidade = parseInt(row.querySelector('.venda-item-qtd').value) || 0;
                    if (quantidade > 0) {
                        const prod = produtos.find(p => p.id === produtoId);
                        itens.push({ produto_id: produtoId, quantidade, preco: prod.preco });
                    }
                });
                submeterPedido(formaPagamento, itens);
            });

            document.getElementById('form-abrir-caixa').addEventListener('submit', (e) => {
                e.preventDefault();
                const valorInicialInput = document.getElementById('caixa-valor-inicial').value.replace(/\./g, '').replace(',', '.');
                if (isNaN(parseFloat(valorInicialInput))) {
                    showToast('Valor inv√°lido.', 'error');
                    return;
                }
                abrirCaixa(parseFloat(valorInicialInput));
            });

            // Bot√µes Principais
            document.getElementById('btn-abrir-modal-produto').addEventListener('click', () => abrirModalProduto());
            document.getElementById('btn-adicionar-produto').addEventListener('click', () => abrirModalProduto());
            document.getElementById('btn-abrir-modal-venda').addEventListener('click', abrirModalVenda);
            document.getElementById('btn-abrir-caixa').addEventListener('click', () => document.getElementById('modal-abrir-caixa').style.display = 'flex');
            document.getElementById('btn-encerrar-caixa').addEventListener('click', encerrarCaixa);
            document.getElementById('btn-hist-caixa').addEventListener('click', () => {
                aplicarFiltros('', true);
                document.getElementById('modal-caixa-hist').style.display = 'flex';
            });

            document.getElementById('btn-add-item').addEventListener('click', addItemRow);

            // Input Moeda
            document.getElementById('prod-preco').addEventListener('keyup', (e) => formatarInputMoeda(e.target));
            document.getElementById('caixa-valor-inicial').addEventListener('keyup', (e) => formatarInputMoeda(e.target));

            // Exporta√ß√µes
            document.getElementById('btn-export-pdf-vendas').addEventListener('click', exportarParaPDF);
            document.getElementById('btn-export-csv-vendas').addEventListener('click', exportarParaCSV);
            document.getElementById('btn-export-pdf-caixa').addEventListener('click', () => exportarConferenciaCaixaPDF());

            // Cards Click
            document.getElementById('card-vendas').addEventListener('click', () => exibirDetalhesModal('Vendas'));
            document.getElementById('card-saldo').addEventListener('click', () => exibirDetalhesModal('Saldo'));

            // Close Modals
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => { 
                    if (e.target === modal) modal.style.display = 'none'; 
                });
            });

            ['btn-fechar-detalhes', 'btn-fechar-produto', 'btn-cancelar-produto', 
             'btn-fechar-venda', 'btn-cancelar-venda', 'btn-fechar-abrir-caixa', 
             'btn-cancelar-abrir-caixa', 'btn-fechar-caixa-hist'].forEach(id => {
                document.getElementById(id)?.addEventListener('click', () => {
                    document.getElementById(id.includes('caixa-hist') ? 'modal-caixa-hist' : 
                        id.includes('detalhes') ? 'modal-detalhes' : 
                        id.includes('produto') ? 'modal-registro-produto' : 
                        id.includes('venda') ? 'modal-registro-venda' : 
                        id.includes('abrir-caixa') ? 'modal-abrir-caixa' : 'modal-abrir-caixa').style.display = 'none';
                });
            });

            // Cliques em A√ß√µes
            document.addEventListener('click', async (e) => {
                // Delete Pedido
                if (e.target.closest('.btn-delete-venda')) {
                    const id = parseInt(e.target.closest('.btn-delete-venda').dataset.id);
                    if (confirm('Excluir pedido?')) excluirPedido(id);
                }
                
                // Edit Produto
                if (e.target.closest('.btn-edit-prod')) {
                    const id = parseInt(e.target.closest('.btn-edit-prod').dataset.id);
                    abrirModalProduto(id);
                }
                
                // Delete Produto
                if (e.target.closest('.btn-delete-prod')) {
                    const id = parseInt(e.target.closest('.btn-delete-prod').dataset.id);
                    if (confirm('Excluir produto?')) excluirProduto(id);
                }
                
                // Export Caixa
                if (e.target.closest('.btn-export-caixa')) {
                    const id = parseInt(e.target.closest('.btn-export-caixa').dataset.id);
                    const caixa = caixasGeral.find(c => c.id === id);
                    exportarConferenciaCaixaPDF(caixa);
                }
            });

            // INIT
            aplicarTema(localStorage.getItem('temaDashboard') || 'light');
            carregarDadosIniciais();
        });
    </script>
</body>
</html>
