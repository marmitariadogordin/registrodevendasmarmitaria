<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marmitaria do Gordin - Sistema Premium</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* === VARIÁVEIS CSS PREMIUM === */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
            --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
        }

        /* === BASE STYLES === */
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Poppins', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 0 20px; }

        /* === HEADER PREMIUM === */
        header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 0;
            box-shadow: var(--shadow-sm);
            position: sticky; top: 0; z-index: 100;
        }

        .header-content {
            display: flex; justify-content: space-between; align-items: center;
            flex-wrap: wrap; gap: 1rem;
        }

        .logo {
            display: flex; align-items: center; gap: 0.75rem;
            font-size: 1.75rem; font-weight: 700;
            background: var(--primary-gradient); -webkit-background-clip: text;
            -webkit-text-fill-color: transparent; background-clip: text;
        }

        .header-actions { display: flex; align-items: center; gap: 1rem; }

        /* === BUTTONS PREMIUM === */
        .btn {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.75rem 1.5rem; border: none; border-radius: var(--radius-md);
            font-weight: 500; cursor: pointer; text-decoration: none;
            transition: var(--transition); font-size: 0.875rem;
            position: relative; overflow: hidden;
        }

        .btn::before {
            content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn:hover::before { left: 100%; }

        .btn-primary { background: var(--primary-gradient); color: white; }
        .btn-success { background: var(--success-gradient); color: white; }
        .btn-danger { background: var(--danger-gradient); color: white; }
        .btn-warning { background: var(--warning-gradient); color: white; }
        .btn-outline { background: transparent; color: var(--text-primary); border: 2px solid var(--border-color); }
        .btn-outline:hover { background: var(--bg-primary); }

        .btn-icon { width: 2.5rem; height: 2.5rem; border-radius: 50%; justify-content: center; font-size: 1rem; }

        .btn-group {
            display: flex; gap: 0.5rem; background: var(--bg-primary);
            padding: 0.5rem; border-radius: var(--radius-lg); border: 1px solid var(--border-color);
        }

        /* === CARDS PREMIUM === */
        .cards-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem; margin: 2rem 0;
        }

        .card {
            background: var(--bg-secondary); border-radius: var(--radius-lg);
            padding: 1.5rem; box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color); transition: var(--transition);
            position: relative; overflow: hidden;
        }

        .card::before {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
            background: var(--primary-gradient);
        }

        .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .card-title { color: var(--text-secondary); font-size: 0.875rem; font-weight: 500; }
        .card-icon { font-size: 1.5rem; }
        .card-value { font-size: 2.25rem; font-weight: 700; margin: 0; line-height: 1.2; }

        .card-vendas .card-value { color: #10b981; }
        .card-pedidos .card-value { color: #3b82f6; }
        .card-caixa .card-value { color: #8b5cf6; }

        /* === FILTERS PREMIUM === */
        .filters {
            background: var(--bg-secondary); padding: 1.5rem; border-radius: var(--radius-lg);
            margin-bottom: 2rem; box-shadow: var(--shadow-md);
            display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; justify-content: space-between;
        }

        .filter-group {
            display: flex; align-items: center; gap: 0.5rem;
            background: var(--bg-primary); padding: 0.5rem 1rem; border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
        }

        .filter-btn {
            padding: 0.5rem 1rem; border: none; background: transparent;
            border-radius: var(--radius-sm); cursor: pointer; transition: var(--transition);
            font-weight: 500;
        }

        .filter-btn.active { background: var(--primary-gradient); color: white; }

        /* === DASHBOARD GRID === */
        .dashboard-grid {
            display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 2rem;
        }

        .widget {
            background: var(--bg-secondary); border-radius: var(--radius-lg);
            padding: 1.5rem; box-shadow: var(--shadow-md); border: 1px solid var(--border-color);
        }

        .widget-title {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 1.5rem; font-size: 1.125rem; font-weight: 600;
        }

        .chart-container { position: relative; height: 350px; width: 100%; }

        /* === TABLES PREMIUM === */
        .table-container { max-height: 400px; overflow-y: auto; border-radius: var(--radius-md); }

        table { width: 100%; border-collapse: collapse; }
        th {
            background: var(--bg-primary); padding: 1rem; text-align: left; font-weight: 600;
            color: var(--text-secondary); border-bottom: 2px solid var(--border-color);
            position: sticky; top: 0; z-index: 10;
        }
        td { padding: 1rem; border-bottom: 1px solid var(--border-color); }
        tr:hover { background: var(--bg-primary); }

        .status-badge {
            padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500;
        }
        .status-aberto { background: #dbeafe; color: #1e40af; }
        .status-fechado { background: #fef3c7; color: #92400e; }

        /* === MODALS PREMIUM === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center;
            z-index: 1000; padding: 1rem; backdrop-filter: blur(4px);
        }

        .modal-content {
            background: var(--bg-secondary); border-radius: var(--radius-lg);
            max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto;
            box-shadow: var(--shadow-lg); animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }

        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem; border-bottom: 1px solid var(--border-color); }

        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-secondary); }
        .form-group input, .form-group select {
            width: 100%; padding: 0.75rem; border: 2px solid var(--border-color);
            border-radius: var(--radius-md); background: var(--bg-primary); color: var(--text-primary);
            transition: var(--transition);
        }
        .form-group input:focus, .form-group select:focus {
            outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .item-row {
            display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 0.5rem; margin: 0.5rem 0;
            align-items: center;
        }

        /* === TOAST NOTIFICATIONS === */
        .toast-container {
            position: fixed; top: 1.5rem; right: 1.5rem; z-index: 2000;
            display: flex; flex-direction: column; gap: 1rem;
        }

        .toast {
            padding: 1rem 1.5rem; border-radius: var(--radius-md); color: white;
            font-weight: 500; box-shadow: var(--shadow-lg);
            transform: translateX(100%); animation: toastSlideIn 0.3s ease-out forwards;
            min-width: 300px;
        }

        @keyframes toastSlideIn { to { transform: translateX(0); } }

        .toast.success { background: var(--success-gradient); }
        .toast.error { background: var(--danger-gradient); }
        .toast.warning { background: var(--warning-gradient); }

        /* === STOCK ALERTS === */
        .stock-low { color: #ef4444; font-weight: 600; }
        .stock-critical { color: #dc2626; font-weight: 700; }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .dashboard-grid { grid-template-columns: 1fr; }
            .filters { flex-direction: column; align-items: stretch; }
            .header-content { flex-direction: column; gap: 1rem; }
            .item-row { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>

    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-utensils"></i> Marmitaria do Gordin
                </div>
                <div class="header-actions">
                    <div class="btn-group">
                        <button class="btn-icon btn-primary" id="btn-export-pdf" title="PDF"><i class="fas fa-file-pdf"></i></button>
                        <button class="btn-icon btn-success" id="btn-export-csv" title="CSV"><i class="fas fa-file-csv"></i></button>
                    </div>
                    <button class="btn-icon btn-outline" id="btn-theme-toggle" title="Tema"><i class="fas fa-moon"></i></button>
                    <div class="btn-group">
                        <button class="btn btn-primary" id="btn-new-product"><i class="fas fa-box"></i> Produto</button>
                        <button class="btn btn-success" id="btn-new-sale"><i class="fas fa-shopping-cart"></i> Pedido</button>
                        <button class="btn btn-warning" id="btn-open-cash"><i class="fas fa-cash-register"></i> Abrir Caixa</button>
                        <button class="btn btn-danger" id="btn-close-cash"><i class="fas fa-lock"></i> Fechar Caixa</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="container">
        <!-- DASHBOARD CARDS -->
        <div class="cards-grid">
            <div class="card card-vendas">
                <div class="card-header">
                    <span class="card-title">Vendas Hoje</span>
                    <i class="fas fa-chart-line card-icon"></i>
                </div>
                <p class="card-value" id="total-vendas">R$ 0,00</p>
            </div>
            <div class="card card-pedidos">
                <div class="card-header">
                    <span class="card-title">Pedidos Hoje</span>
                    <i class="fas fa-shopping-cart card-icon"></i>
                </div>
                <p class="card-value" id="total-pedidos">0</p>
            </div>
            <div class="card card-caixa">
                <div class="card-header">
                    <span class="card-title">Caixa</span>
                    <i class="fas fa-cash-register card-icon"></i>
                </div>
                <p class="card-value status-fechado" id="caixa-status">Fechado</p>
            </div>
        </div>

        <!-- FILTERS -->
        <div class="filters">
            <div class="filter-group">
                <button class="filter-btn active" data-period="hoje">Hoje</button>
                <button class="filter-btn" data-period="semana">Semana</button>
                <button class="filter-btn" data-period="mes">Mês</button>
                <button class="filter-btn" data-period="ano">Ano</button>
            </div>
            <div class="filter-group">
                <input type="date" id="date-from">
                <input type="date" id="date-to">
                <button class="btn btn-primary" id="apply-date-filter">Filtrar</button>
            </div>
        </div>

        <!-- DASHBOARD -->
        <div class="dashboard-grid">
            <div class="widget">
                <div class="widget-title">
                    <span>Evolução de Vendas</span>
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="chart-container">
                    <canvas id="sales-chart"></canvas>
                </div>
            </div>

            <div class="widget">
                <div class="widget-title">
                    <span>Top Produtos</span>
                    <i class="fas fa-chart-pie"></i>
                </div>
                <div class="chart-container">
                    <canvas id="products-chart"></canvas>
                </div>
            </div>

            <div class="widget" style="grid-column: 1 / -1;">
                <div class="widget-title">
                    <span>Estoque de Produtos</span>
                    <button class="btn-icon btn-success" id="add-product-quick"><i class="fas fa-plus"></i></button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Preço</th>
                                <th>Estoque</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="stock-table"></tbody>
                    </table>
                </div>
            </div>

            <div class="widget" style="grid-column: 1 / -1;">
                <div class="widget-title">
                    <span>Últimos Pedidos</span>
                    <button class="btn btn-primary" id="view-all-sales">Ver Todos</button>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Cliente</th>
                                <th>Itens</th>
                                <th>Total</th>
                                <th>Pagamento</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="sales-table"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALS -->
    <!-- Modal Novo Produto -->
    <div class="modal-overlay" id="modal-product">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Novo Produto</h3>
                <button class="btn-icon btn-danger" id="close-product-modal">&times;</button>
            </div>
            <form id="product-form">
                <div class="form-group">
                    <label>Nome</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label>Preço (R$)</label>
                    <input type="text" id="product-price" placeholder="0,00" required>
                </div>
                <div class="form-group">
                    <label>Estoque</label>
                    <input type="number" id="product-stock" min="0" required>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="product-category" required>
                        <option value="carne">Carne</option>
                        <option value="frango">Frango</option>
                        <option value="peixe">Peixe</option>
                        <option value="vegetariano">Vegetariano</option>
                        <option value="sobremesa">Sobremesa</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" id="cancel-product">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Novo Pedido -->
    <div class="modal-overlay" id="modal-sale">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3>Novo Pedido</h3>
                <button class="btn-icon btn-danger" id="close-sale-modal">&times;</button>
            </div>
            <form id="sale-form">
                <div class="form-group">
                    <label>Cliente</label>
                    <input type="text" id="client-name" placeholder="Nome do cliente">
                </div>
                <div class="form-group">
                    <label>Pagamento</label>
                    <select id="payment-method" required>
                        <option value="dinheiro">Dinheiro</option>
                        <option value="pix">Pix</option>
                        <option value="cartao">Cartão</option>
                    </select>
                </div>
                <div id="order-items">
                    <div class="item-row">
                        <select class="item-product"></select>
                        <input type="number" class="item-quantity" min="1" value="1">
                        <span class="item-total">R$ 0,00</span>
                        <button type="button" class="btn-icon btn-danger remove-item">&times;</button>
                    </div>
                </div>
                <button type="button" class="btn btn-success" id="add-item">+ Item</button>
                <div style="margin: 1rem 0; font-size: 1.25rem; font-weight: 600;">
                    Total: <span id="order-total">R$ 0,00</span>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" id="cancel-sale">Cancelar</button>
                    <button type="submit" class="btn btn-success">Finalizar Pedido</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Abrir Caixa -->
    <div class="modal-overlay" id="modal-cash">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Abrir Caixa</h3>
                <button class="btn-icon btn-danger" id="close-cash-modal">&times;</button>
            </div>
            <form id="cash-form">
                <div class="form-group">
                    <label>Valor Inicial (R$)</label>
                    <input type="text" id="cash-amount" placeholder="0,00" required>
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button type="button" class="btn btn-outline" id="cancel-cash">Cancelar</button>
                    <button type="submit" class="btn btn-success">Abrir Caixa</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            'use strict';

            // === SUPABASE CONFIG (INTACTO) ===
            const SUPABASE_URL = 'https://jrbhvzczkzuyigwiomaa.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpyYmh2emN6a3p1eWlnd2lvbWFhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NzQzNDUsImV4cCI6MjA3NjU1MDM0NX0.bs4GzZa2iPCkuvOUy4OpKmuT2n6NLPr857Qe1hytJSc';
            const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // === VARIÁVEIS GLOBAIS ===
            let produtos = [], pedidosGeral = [], itensGeral = [], caixasGeral = [], caixaAtual = null;
            let graficoLinhas = null, graficoCategorias = null;
            let periodoAtual = 'hoje';

            // === FUNÇÕES AUXILIARES ===
            const formatarMoeda = (valor) => (valor || 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const formatarData = (data) => new Date(data).toLocaleDateString('pt-BR');

            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'times'}-circle"></i> ${message}`;
                document.getElementById('toast-container').appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            }

            function aplicarTema() {
                const tema = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
                document.documentElement.dataset.theme = tema;
                document.getElementById('btn-theme-toggle').innerHTML = `<i class="fas fa-${tema === 'dark' ? 'sun' : 'moon'}"></i>`;
            }

            // === CARREGAR DADOS ===
            async function carregarDados() {
                try {
                    // Produtos
                    const { data: produtosData } = await supabase.from('produtos').select('*');
                    produtos = produtosData || [];

                    // Pedidos
                    const { data: pedidosData } = await supabase.from('pedidos').select('*');
                    pedidosGeral = pedidosData.map(p => ({ ...p, data: new Date(p.data) })) || [];

                    // Itens
                    const { data: itensData } = await supabase.from('itens_pedido').select('*, produto:produto_id(*)');
                    itensGeral = itensData.map(i => ({ ...i, produto_nome: i.produto?.nome || 'Desconhecido' })) || [];

                    // Caixas
                    const { data: caixasData } = await supabase.from('caixa').select('*').order('data_abertura', { ascending: false });
                    caixasGeral = caixasData.map(c => ({ 
                        ...c, 
                        data_abertura: new Date(c.data_abertura),
                        data_encerramento: c.data_encerramento ? new Date(c.data_encerramento) : null 
                    })) || [];
                    caixaAtual = caixasGeral.find(c => !c.data_encerramento) || null;

                    renderTudo();
                    showToast('Dados carregados!', 'success');
                } catch (error) {
                    console.error('Erro:', error);
                    showToast('Erro ao carregar dados', 'error');
                }
            }

            // === RENDERIZAÇÃO ===
            function renderTudo() {
                renderCards();
                renderEstoque();
                renderPedidos();
                renderGraficos();
                renderItensPedido();
            }

            function renderCards() {
                const hoje = new Date().toDateString();
                const vendasHoje = pedidosGeral.filter(p => p.data.toDateString() === hoje).reduce((sum, p) => sum + p.valor_total, 0);
                const pedidosHoje = pedidosGeral.filter(p => p.data.toDateString() === hoje).length;
                const status = caixaAtual ? 'Aberto' : 'Fechado';

                document.getElementById('total-vendas').textContent = formatarMoeda(vendasHoje);
                document.getElementById('total-pedidos').textContent = pedidosHoje;
                const statusEl = document.getElementById('caixa-status');
                statusEl.textContent = status;
                statusEl.className = `card-value ${status === 'Aberto' ? 'status-aberto' : 'status-fechado'}`;
            }

            function renderEstoque() {
                const tbody = document.getElementById('stock-table');
                tbody.innerHTML = produtos.map(prod => {
                    const stockClass = prod.estoque < 5 ? 'stock-low' : prod.estoque < 2 ? 'stock-critical' : '';
                    return `
                        <tr>
                            <td>${prod.nome}</td>
                            <td>${formatarMoeda(prod.preco)}</td>
                            <td class="${stockClass}">${prod.estoque}</td>
                            <td><span class="status-badge ${stockClass}">${prod.estoque < 5 ? 'Baixo' : 'OK'}</span></td>
                            <td>
                                <button class="btn-icon btn-primary edit-product" data-id="${prod.id}"><i class="fas fa-edit"></i></button>
                                <button class="btn-icon btn-danger delete-product" data-id="${prod.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="5" style="text-align:center;padding:2rem">Nenhum produto</td></tr>';
            }

            function renderPedidos() {
                const ultimos = pedidosGeral.slice(-5).reverse();
                document.getElementById('sales-table').innerHTML = ultimos.map(p => {
                    const itens = itensGeral.filter(i => i.pedido_id === p.id).map(i => i.produto_nome).join(', ');
                    return `
                        <tr>
                            <td>${formatarData(p.data)}</td>
                            <td>${p.cliente || 'Cliente'}</td>
                            <td>${itens}</td>
                            <td>${formatarMoeda(p.valor_total)}</td>
                            <td>${p.forma_pagamento}</td>
                            <td>
                                <button class="btn-icon btn-danger delete-sale" data-id="${p.id}"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                }).join('') || '<tr><td colspan="6" style="text-align:center;padding:2rem">Nenhum pedido</td></tr>';
            }

            function renderGraficos() {
                // Gráfico Linhas
                if (graficoLinhas) graficoLinhas.destroy();
                const ctx1 = document.getElementById('sales-chart').getContext('2d');
                const vendasPorDia = {};
                pedidosGeral.forEach(p => {
                    const dia = p.data.toLocaleDateString();
                    vendasPorDia[dia] = (vendasPorDia[dia] || 0) + p.valor_total;
                });
                
                graficoLinhas = new Chart(ctx1, {
                    type: 'line',
                    data: {
                        labels: Object.keys(vendasPorDia),
                        datasets: [{
                            label: 'Vendas',
                            data: Object.values(vendasPorDia),
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });

                // Gráfico Categorias
                if (graficoCategorias) graficoCategorias.destroy();
                const ctx2 = document.getElementById('products-chart').getContext('2d');
                const produtosVendidos = itensGeral.reduce((acc, i) => {
                    acc[i.produto_nome] = (acc[i.produto_nome] || 0) + i.quantidade;
                    return acc;
                }, {});
                
                graficoCategorias = new Chart(ctx2, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(produtosVendidos).slice(0, 5),
                        datasets: [{
                            data: Object.values(produtosVendidos).slice(0, 5),
                            backgroundColor: ['#10b981', '#3b82f6', '#8b5cf6', '#f59e0b', '#ef4444']
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }

            function renderItensPedido() {
                const selects = document.querySelectorAll('.item-product');
                selects.forEach(select => {
                    select.innerHTML = produtos.map(p => 
                        `<option value="${p.id}">${p.nome} - R$ ${p.preco.toFixed(2)} (Est: ${p.estoque})</option>`
                    ).join('');
                });
            }

            // === OPERAÇÕES SUPABASE ===
            async function adicionarProduto(produto) {
                const { error } = await supabase.from('produtos').insert([produto]);
                if (!error) {
                    carregarDados();
                    showToast('Produto adicionado!', 'success');
                } else showToast('Erro ao adicionar', 'error');
            }

            async function adicionarPedido(pedidoData, itens) {
                if (!caixaAtual) return showToast('Abra o caixa primeiro!', 'error');
                
                const { data: pedido } = await supabase.from('pedidos').insert([pedidoData]).select().single();
                const itensInsert = itens.map(i => ({ pedido_id: pedido.id, produto_id: i.produto_id, quantidade: i.quantidade, preco_unitario: i.preco }));
                
                await supabase.from('itens_pedido').insert(itensInsert);
                
                // Atualizar estoque
                itens.forEach(async i => {
                    await supabase.from('produtos').update({ estoque: Math.max(0, i.estoque - i.quantidade) }).eq('id', i.produto_id);
                });

                carregarDados();
                showToast('Pedido registrado!', 'success');
            }

            async function abrirCaixa(valor) {
                if (caixaAtual) return showToast('Caixa já aberto!', 'error');
                const { error } = await supabase.from('caixa').insert([{ data_abertura: new Date().toISOString(), valor_inicial: valor }]);
                if (!error) carregarDados();
            }

            async function fecharCaixa() {
                if (!caixaAtual) return showToast('Nenhum caixa aberto!', 'error');
                const totalVendas = pedidosGeral.filter(p => 
                    new Date(p.data) >= caixaAtual.data_abertura
                ).reduce((sum, p) => sum + p.valor_total, 0);
                
                await supabase.from('caixa').update({ 
                    data_encerramento: new Date().toISOString(), 
                    valor_final: caixaAtual.valor_inicial + totalVendas 
                }).eq('id', caixaAtual.id);
                
                carregarDados();
            }

            // === EVENT LISTENERS ===
            // Theme
            document.getElementById('btn-theme-toggle').addEventListener('click', aplicarTema);

            // Filtros
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    periodoAtual = btn.dataset.period;
                    carregarDados();
                });
            });

            // Forms
            document.getElementById('product-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const preco = parseFloat(document.getElementById('product-price').value.replace(',', '.'));
                await adicionarProduto({
                    nome: document.getElementById('product-name').value,
                    preco,
                    estoque: parseInt(document.getElementById('product-stock').value),
                    categoria: document.getElementById('product-category').value
                });
                document.getElementById('modal-product').style.display = 'none';
            });

            document.getElementById('sale-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const itens = Array.from(document.querySelectorAll('.item-row')).map(row => {
                    const select = row.querySelector('.item-product');
                    const qty = row.querySelector('.item-quantity');
                    const produto = produtos.find(p => p.id == select.value);
                    if (parseInt(qty.value) > 0 && produto.estoque >= parseInt(qty.value)) {
                        return { produto_id: produto.id, quantidade: parseInt(qty.value), preco: produto.preco, estoque: produto.estoque };
                    }
                }).filter(Boolean);

                if (itens.length === 0) return showToast('Adicione itens válidos!', 'error');

                await adicionarPedido({
                    data: new Date().toISOString(),
                    cliente: document.getElementById('client-name').value,
                    forma_pagamento: document.getElementById('payment-method').value,
                    valor_total: itens.reduce((sum, i) => sum + (i.preco * i.quantidade), 0)
                }, itens);

                document.getElementById('modal-sale').style.display = 'none';
            });

            document.getElementById('cash-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const valor = parseFloat(document.getElementById('cash-amount').value.replace(',', '.'));
                await abrirCaixa(valor);
                document.getElementById('modal-cash').style.display = 'none';
            });

            // Botões
            document.getElementById('btn-new-product').addEventListener('click', () => document.getElementById('modal-product').style.display = 'flex');
            document.getElementById('add-product-quick').addEventListener('click', () => document.getElementById('modal-product').style.display = 'flex');
            document.getElementById('btn-new-sale').addEventListener('click', () => document.getElementById('modal-sale').style.display = 'flex');
            document.getElementById('btn-open-cash').addEventListener('click', () => document.getElementById('modal-cash').style.display = 'flex');
            document.getElementById('btn-close-cash').addEventListener('click', fecharCaixa);

            // Add Item
            document.getElementById('add-item').addEventListener('click', () => {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <select class="item-product"></select>
                    <input type="number" class="item-quantity" min="1" value="1">
                    <span class="item-total">R$ 0,00</span>
                    <button type="button" class="btn-icon btn-danger remove-item">&times;</button>
                `;
                document.getElementById('order-items').appendChild(div);
                renderItensPedido();
                updateOrderTotal();
            });

            // Delete Events
            document.addEventListener('click', async (e) => {
                if (e.target.classList.contains('delete-product')) {
                    if (confirm('Excluir produto?')) {
                        await supabase.from('produtos').delete().eq('id', e.target.dataset.id);
                        carregarDados();
                    }
                }
                if (e.target.classList.contains('delete-sale')) {
                    if (confirm('Cancelar pedido?')) {
                        await supabase.from('pedidos').delete().eq('id', e.target.dataset.id);
                        carregarDados();
                    }
                }
                if (e.target.classList.contains('remove-item')) e.target.closest('.item-row').remove();
            });

            // Close Modals
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.addEventListener('click', (e) => { if (e.target === modal) modal.style.display = 'none'; });
            });

            // Update Order Total
            document.addEventListener('input', (e) => {
                if (e.target.classList.contains('item-product') || e.target.classList.contains('item-quantity')) {
                    updateOrderTotal();
                }
            });

            function updateOrderTotal() {
                let total = 0;
                document.querySelectorAll('.item-row').forEach(row => {
                    const select = row.querySelector('.item-product');
                    const qty = row.querySelector('.item-quantity');
                    const produto = produtos.find(p => p.id == select.value);
                    if (produto) {
                        const subtotal = produto.preco * parseInt(qty.value || 0);
                        row.querySelector('.item-total').textContent = formatarMoeda(subtotal);
                        total += subtotal;
                    }
                });
                document.getElementById('order-total').textContent = formatarMoeda(total);
            }

            // INIT
            aplicarTema();
            carregarDados();
        });
    </script>
</body>
</html>
